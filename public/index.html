<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inua CRM - Login</title>
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <div class="container">

        <div class="left-side">
            <h1>Inua Solutions</h1>
            <h2>Access to Goods on Credit for Rural Households</h2>
            <p>At Inua Solutions, we believe in empowering rural communities by providing access to essential goods through flexible credit options. Our innovative platform bridges the gap between rural households and quality products, fostering economic growth and improving living standards.</p>
            <p>Join us in our mission to transform rural economies and create sustainable opportunities for families across the region.</p>
        </div>

        <div class="right-side">
            <div id="netlify-modal"></div>
            <button id="login">Log In</button>
            <button id="signup">Sign Up</button>
            <button id="password-reset">Reset Password</button>
        </div>
    </div>

    <script>
        // Initialize Netlify Identity
        const netlifyIdentity = window.netlifyIdentity;
        netlifyIdentity.on('init', user => {
            if (user) {
                redirectToDashboard(user);
            }
        });

        // Login
        document.getElementById('login').addEventListener('click', () => {
            netlifyIdentity.open('login');
        });

        // Signup
        document.getElementById('signup').addEventListener('click', () => {
            netlifyIdentity.open('signup');
        });

        // Password Reset
        document.getElementById('password-reset').addEventListener('click', () => {
            netlifyIdentity.open('recovery');
        });

        // Handle successful login
        netlifyIdentity.on('login', user => {
            saveUserToDatabase(user)
                .then(() => redirectToDashboard(user))
                .catch(error => console.error('Error saving user:', error));
        });

        function saveUserToDatabase(user) {
            return fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${user.token.access_token}`
                },
                body: JSON.stringify({
                    name: user.user_metadata.full_name,
                    email: user.email,
                    role: user.user_metadata.role || 'customer_service' // Default role
                })
            }).then(response => response.json());
        }

        function redirectToDashboard(user) {
            localStorage.setItem('jwt', user.token.access_token);
            window.location.href = '/dashboard.html';
        }
    </script>
</body>
</html>