<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - Inua CRM</title>
        <!-- Link to the main stylesheet -->
        <link rel="stylesheet" href="./css/style.css">
        <!-- Preconnect to Google Fonts for performance optimization -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <!-- Import Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Moderustic:wght@300..800&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text:ital@0;1&family=Moderustic:wght@300..800&display=swap" rel="stylesheet">
        <!-- Import Bootstrap CSS from CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <!-- Import custom JavaScript modules -->
        <script src="./js/notificationComponent.js"></script>
        <script type="module">
            import { errorHandler } from './js/errorHandler.js';
            // Your other JavaScript code here
        </script>
    </head>
    <body class="dashboard bg-gray-100">
    <!-- Navigation bar -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-2 flex items-center justify-between">
            <!-- Logo section -->
            <div class="logo">
                <img id="logo" src="./img/logo_v2-removebg-preview.png" alt="Inua Solutions Logo" class="h-12">
            </div>
            <!-- Navigation links -->
            <ul id="nav-links" class="flex space-x-4">
                <li><a href="#" class="nav-link active">Dashboard</a></li>
                <li><a href="#" class="nav-link">Customer Management</a></li>
                <li><a href="#" class="nav-link">Sales Management</a></li>
                <li><a href="#" class="nav-link">Payment Tracking</a></li>
                <li><a href="#" class="nav-link">Support Tickets</a></li>
                <li><a href="#" class="nav-link">Reports & Analytics</a></li>
                <li id="userManagementLink" class="hidden"><a href="#" class="nav-link">User Management</a></li>
            </ul>
            <!-- User actions section -->
            <div class="flex items-center space-x-4">
                <!-- Notification bell -->
                <div class="relative">
                    <button id="notificationBell" class="relative focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11c0-2.21-1.343-4.21-3.268-5.015A4.997 4.997 0 0012 2a4.997 4.997 0 00-2.732 3.985C6.343 6.79 5 8.79 5 11v3.159c0 .538-.214 1.052-.595 1.437L3 17h5m6 0a3 3 0 01-6 0m6 0H9" />
                        </svg>
                        <span id="notificationCount" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span>
                    </button>
                </div>
                <!-- User avatar -->
                <div class="relative">
                    <button id="avatarButton" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center focus:outline-none">
                        <span id="avatarPlaceholder" class="text-gray-600"></span>
                        <img id="avatarImage" class="w-full h-full rounded-full hidden object-cover" alt="User Avatar">
                    </button>
                </div>
                <!-- Logout button -->
                <button id="logout" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 focus:outline-none">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main content area -->
    <main class="container mx-auto mt-8 px-4">
        <h2 class="text-2xl font-bold mb-4">Welcome to Inua CRM Dashboard</h2>
        <!-- User information section -->
        <div id="user-info" class="bg-white shadow rounded-lg p-4 mb-4"></div>
        <!-- Role-based content section -->
        <div id="role-based-content" class="bg-white shadow rounded-lg p-4 mb-4"></div>
        <!-- Notification component -->
        <div id="notification-component"></div>
        <!-- User approval modal -->
        <div id="user-approval-modal"></div>
    </main>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Profile</h3>
                <div class="mt-2 px-7 py-3">
                    <!-- Profile form -->
                    <form id="profileForm">
                        <!-- Role selection -->
                        <div class="mb-4">
                            <label for="profileRole" class="block text-gray-700 text-sm font-bold mb-2">Role:</label>
                            <select id="profileRole" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="customer_service">Customer Service</option>
                                <option value="sales_manager">Sales Manager</option>
                                <option value="group_coordinator">Group Coordinator</option>
                                <option value="management">Management</option>
                            </select>
                        </div>
                        <!-- Avatar upload -->
                        <div class="mb-4">
                            <label for="profileAvatar" class="block text-gray-700 text-sm font-bold mb-2">Avatar:</label>
                            <input type="file" id="profileAvatar" accept="image/*" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <!-- Reset password button -->
                        <div class="mb-4">
                            <button type="button" id="resetPassword" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Reset Password
                            </button>
                        </div>
                        <!-- Save and close buttons -->
                        <div class="flex items-center justify-between">
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Save Changes
                            </button>
                            <button type="button" id="closeProfileModal" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Close
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer>
        <p>&copy; 2024 Inua Solutions. All rights reserved.</p>
        <p><a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
    </footer>

    <!-- JavaScript code -->
    <script type="module">
        // Custom error classes
        class ModalError extends Error {
            constructor(message) {
                super(message);
                this.name = 'ModalError';
            }
        }

        class APIError extends Error {
            constructor(message) {
                super(message);
                this.name = 'APIError';
            }
        }

        class AuthError extends Error {
            constructor(message) {
                super(message);
                this.name = 'AuthError';
            }
        }

        // Function to handle API calls and throw custom errors
        async function apiCall(url, options) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new AuthError('Authentication failed');
                    }
                    throw new APIError('API request failed');
                }
                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Function to display modals
        function showModal(modalId) {
            try {
                const modalElement = document.getElementById(modalId);
                if (!modalElement) {
                    throw new ModalError(`Modal with id ${modalId} not found`);
                }
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } catch (error) {
                console.error('Modal error:', error);
                throw error;
            }
        }

        // Function to check login status
        async function checkLoginStatus() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) {
                window.location.href = '/index.html';
                throw new AuthError('No JWT token found');
            }

            try {
                const response = await apiCall('/api/verify-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwt}`
                    }
                });

                if (!response.valid) {
                    throw new AuthError('Token is invalid');
                }
            } catch (error) {
                console.error('Login check failed:', error);
                localStorage.removeItem('jwt');
                window.location.href = '/index.html';
            }
        }

        // Event listener for DOMContentLoaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await checkLoginStatus();
                showModal('myModal');
                loadNotifications();
                loadRoleBasedContent();
            } catch (error) {
                console.error('Initialization error:', error);
                alert(error.message);
            }
        });

        // Function to save role to the database
        async function saveRoleToDatabase(role) {
            try {
                const jwt = localStorage.getItem('jwt');
                const result = await apiCall('/api/update-role', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify({ role })
                });
                console.log('Role updated successfully:', result);
                location.reload();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Failed to update role. Please try again.');
            }
        }

        // Import and use the handleError function from there when needed
        import { errorHandler } from './js/errorHandler.js';

        // Function to fetch notifications
        async function fetchNotifications() {
            try {
                const response = await apiCall('/api/notifications', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (response.notifications.length === 0) {
                    return '<div>No notifications found</div>';
                }

                return response.notifications.map(notification => `<div>${notification.message}</div>`).join('');
            } catch (error) {
                console.error('Error fetching notifications:', error);
                throw error;
            }
        }

        // Function to load notifications
        async function loadNotifications() {
            const notificationComponent = document.getElementById('notification-component');
            notificationComponent.innerHTML = await fetchNotifications();
        }

        // Function to load role-based content
        async function loadRoleBasedContent() {
            const roleBasedContent = document.getElementById('role-based-content');
            const userRole = await fetchUserRole();
            roleBasedContent.innerHTML = getRoleBasedHTML(userRole);
        }

        // Function to get HTML content based on user role
        function getRoleBasedHTML(role) {
            switch(role) {
                case 'admin':
                    return '<h2>Admin Dashboard</h2><button onclick="showUserApprovalModal()">Approve Users</button>';
                case 'sales_manager':
                    return '<h2>Sales Manager Dashboard</h2>';
                // Add more roles as needed
                default:
                    return '<h2>User Dashboard</h2>';
            }
        }

        // Function to show user approval modal
        async function showUserApprovalModal() {
            try {
                const jwt = localStorage.getItem('jwt');
                const response = await fetch('/api/pending-approvals', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    }
                });
                const pendingApprovals = await response.json();

                if (pendingApprovals.length === 0) {
                    alert('No pending approvals.');
                    return;
                }

                const modalContent = pendingApprovals.map(user => `
                    <div class="approval-item">
                        <p>User: ${user.name} (${user.email})</p>
                        <select id="role-${user.id}">
                            <option value="customer_service">Customer Service</option>
                            <option value="sales_manager">Sales Manager</option>
                            <option value="group_leader">Group Leader</option>
                            <option value="other_manager">Other Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button onclick="approveUser(${user.id}, true, document.getElementById('role-${user.id}').value)">Approve</button>
                        <button onclick="approveUser(${user.id}, false)">Reject</button>
                    </div>
                `).join('');

                const modal = document.createElement('div');
                modal.id = 'user-approval-modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="document.getElementById('user-approval-modal').remove()">&times;</span>
                        <h3>Pending User Approvals</h3>
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error fetching pending approvals:', error);
                alert('Failed to load pending approvals. Please try again.');
            }
        }

        // Function to approve or reject a user
        async function approveUser(userId, approved, role = null) {
            try {
                const jwt = localStorage.getItem('jwt');
                const response = await fetch('/api/approve-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwt}`
                    },
                    body: JSON.stringify({ userId, approved, role })
                });
                const data = await response.json();

                if (data.success) {
                    alert('User approval status updated successfully.');
                    document.getElementById('user-approval-modal').remove();
                    loadNotifications(); // Refresh notifications
                } else {
                    alert('Failed to update user approval status. Please try again.');
                }
            } catch (error) {
                console.error('Error updating user approval status:', error);
                alert('Failed to update user approval status. Please try again.');
            }
        }

        // Load notifications when the dashboard is loaded
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>
    </body>
</html>